<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ngau Calculator</title>
    <link rel="manifest" href="manifest.json">
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
            background-color: #1c1c1e; 
            color: white;
            margin: 0; 
            padding: 20px; 
            display: flex; 
            flex-direction: column; 
            align-items: center;
            height: 100vh;
            box-sizing: border-box;
        }
        
        /* Display Area */
        .display-area { width: 100%; max-width: 400px; margin-bottom: 20px; }
        .card-slots { display: flex; justify-content: space-between; gap: 8px; margin-bottom: 15px; }
        .slot { 
            flex: 1; aspect-ratio: 2.5/3.5; background: #2c2c2e; border-radius: 8px; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            font-size: 20px; font-weight: bold; color: #fff;
            border: 1px solid #3a3a3c;
        }
        .slot.filled.Spades, .slot.filled.Clubs { color: white; background: #3a3a3c; }
        .slot.filled.Hearts, .slot.filled.Diamonds { color: #ff453a; background: #3a3a3c; }
        
        #result { 
            text-align: center; font-size: 24px; font-weight: bold; color: #32ade6; 
            min-height: 30px; margin-bottom: 20px;
        }

        /* Keyboard Area */
        .keyboard { width: 100%; max-width: 400px; display: flex; flex-direction: column; gap: 15px; }
        
        .suit-row { display: flex; justify-content: space-between; gap: 10px; }
        .suit-btn { 
            flex: 1; padding: 15px 0; font-size: 24px; background: #2c2c2e; 
            border: none; border-radius: 10px; color: white; cursor: pointer;
        }
        .suit-btn.active { background: #007aff; }
        .suit-btn.Hearts, .suit-btn.Diamonds { color: #ff453a; }
        .suit-btn.active.Hearts, .suit-btn.active.Diamonds { color: white; background: #ff453a; }

        .rank-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .key-btn { 
            padding: 15px 0; font-size: 22px; font-weight: bold; background: #3a3a3c; 
            border: none; border-radius: 10px; color: white; cursor: pointer;
        }
        .key-btn:active { background: #505055; }
        .key-btn:disabled { background: #1c1c1e; color: #4a4a4c; cursor: not-allowed; }

        .control-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 5px; }
        .ctrl-btn { 
            padding: 15px; font-size: 18px; font-weight: bold; border: none; 
            border-radius: 10px; cursor: pointer; 
        }
        .btn-clear { background: #ff453a; color: white; }
        .btn-del { background: #ff9f0a; color: white; }
    </style>
</head>
<body>

    <div class="display-area">
        <div class="card-slots" id="slots">
            <div class="slot"></div><div class="slot"></div><div class="slot"></div><div class="slot"></div><div class="slot"></div>
        </div>
        <div id="result">Select 5 cards</div>
    </div>

    <div class="keyboard">
        <div class="suit-row">
            <button class="suit-btn active Spades" onclick="setSuit('Spades')">♠</button>
            <button class="suit-btn Hearts" onclick="setSuit('Hearts')">♥</button>
            <button class="suit-btn Clubs" onclick="setSuit('Clubs')">♣</button>
            <button class="suit-btn Diamonds" onclick="setSuit('Diamonds')">♦</button>
        </div>

        <div class="rank-grid" id="rank-keys">
            </div>

        <div class="control-row">
            <button class="ctrl-btn btn-clear" onclick="clearCards()">CLEAR ALL</button>
            <button class="ctrl-btn btn-del" onclick="deleteCard()">DELETE ⌫</button>
        </div>
    </div>

    <script>
        // State variables
        let selectedCards = [];
        let currentSuit = 'Spades';
        const suitSymbols = { 'Spades': '♠', 'Hearts': '♥', 'Clubs': '♣', 'Diamonds': '♦' };
        const ranks = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];

        // Ngau Logic dictionaries
        const points = { 'A':1, '2':2, '3':3, '4':4, '5':5, '6':6, '7':7, '8':8, '9':9, '10':10, 'J':10, 'Q':10, 'K':10 };
        const rankPower = { 'A':1, '2':2, '3':3, '4':4, '5':5, '6':6, '7':7, '8':8, '9':9, '10':10, 'J':11, 'Q':12, 'K':13 };

        // Initialize Keyboard
        function initKeyboard() {
            const grid = document.getElementById('rank-keys');
            grid.innerHTML = '';
            ranks.forEach(rank => {
                const btn = document.createElement('button');
                btn.className = 'key-btn';
                btn.innerText = rank;
                btn.onclick = () => addCard(rank);
                btn.id = `btn-${rank}`;
                grid.appendChild(btn);
            });
            updateKeyboardState();
        }

        function setSuit(suit) {
            currentSuit = suit;
            document.querySelectorAll('.suit-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.suit-btn.${suit}`).classList.add('active');
            updateKeyboardState();
        }

        // Lock out buttons if the card is already in the hand (Deck rule)
        function updateKeyboardState() {
            ranks.forEach(rank => {
                const btn = document.getElementById(`btn-${rank}`);
                const isCardUsed = selectedCards.some(c => c.suit === currentSuit && c.rank === rank);
                btn.disabled = isCardUsed || selectedCards.length >= 5;
            });
        }

        function addCard(rank) {
            if (selectedCards.length < 5) {
                selectedCards.push({ suit: currentSuit, rank: rank });
                updateUI();
            }
        }

        function deleteCard() {
            if (selectedCards.length > 0) {
                selectedCards.pop();
                updateUI();
            }
        }

        function clearCards() {
            selectedCards = [];
            updateUI();
        }

        function updateUI() {
            // Update Slots
            const slots = document.getElementById('slots').children;
            for (let i = 0; i < 5; i++) {
                if (i < selectedCards.length) {
                    const card = selectedCards[i];
                    slots[i].innerHTML = `<span>${card.rank}</span><span>${suitSymbols[card.suit]}</span>`;
                    slots[i].className = `slot filled ${card.suit}`;
                } else {
                    slots[i].innerHTML = '';
                    slots[i].className = 'slot';
                }
            }
            
            updateKeyboardState();

            // Auto-calculate if 5 cards are selected
            if (selectedCards.length === 5) {
                calculateNgau();
            } else {
                document.getElementById('result').innerText = `Select ${5 - selectedCards.length} more card(s)`;
                document.getElementById('result').style.color = '#8e8e93';
            }
        }

        // The Engine
        function calculateNgau() {
            if (selectedCards.every(c => ['10', 'J', 'Q', 'K'].includes(c.rank))) {
                showResult("五公 (Five Dukes)", '#30d158'); return;
            }

            let variations = selectedCards.map(c => {
                if(c.rank === '3') return [3, 6];
                if(c.rank === '6') return [6, 3];
                return [points[c.rank]];
            });

            const generateCombos = (arr) => arr.reduce((a, b) => a.flatMap(d => b.map(e => [d, e].flat())));
            let allPointCombos = generateCombos(variations);
            
            let bestScore = -1;
            let bestName = "破柴 (No Ox)";
            const indices = [[0,1,2], [0,1,3], [0,1,4], [0,2,3], [0,2,4], [0,3,4], [1,2,3], [1,2,4], [1,3,4], [2,3,4]];

            for (let pointSet of allPointCombos) {
                for (let idx of indices) {
                    let oxSum = pointSet[idx[0]] + pointSet[idx[1]] + pointSet[idx[2]];
                    
                    if (oxSum % 10 === 0) {
                        let remIdx = [0,1,2,3,4].filter(i => !idx.includes(i));
                        let c1 = selectedCards[remIdx[0]], c2 = selectedCards[remIdx[1]];
                        let v1 = pointSet[remIdx[0]], v2 = pointSet[remIdx[1]];
                        
                        let {score, name} = scoreRemainder(c1, c2, v1, v2);
                        if (score > bestScore) {
                            bestScore = score;
                            bestName = name;
                        }
                    }
                }
            }
            showResult(bestName, bestScore > 0 ? '#32ade6' : '#ff453a');
        }

        function scoreRemainder(c1, c2, v1, v2) {
            let isSpadesAce = (c1.suit === 'Spades' && c1.rank === 'A') || (c2.suit === 'Spades' && c2.rank === 'A');
            let isPic = ['J','Q','K'].includes(c1.rank) || ['J','Q','K'].includes(c2.rank);
            if (isSpadesAce && isPic) return {score: 500, name: "牛吞牯 (Ngau Ton Ku)"};

            if (c1.rank === c2.rank) return {score: 400 + rankPower[c1.rank], name: `孖${c1.rank} (Ma ${c1.rank})`};

            let remainder = (v1 + v2) % 10;
            if (remainder === 0) return {score: 300, name: "牛十 (Ngau 10)"};
            return {score: 200 + remainder, name: `牛${remainder} (Ngau ${remainder})`};
        }

        function showResult(text, color) {
            const res = document.getElementById('result');
            res.innerText = text;
            res.style.color = color;
        }

        // Boot up
        initKeyboard();
    </script>
</body>
</html>